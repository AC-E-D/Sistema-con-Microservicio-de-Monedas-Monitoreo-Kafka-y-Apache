<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Monitoreo</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4">

    <div class="d-flex justify-content-between mb-3">
        <h2>Dashboard de Monitoreo</h2>
        <a href="{% url 'productos' %}" class="btn btn-secondary">Volver a Productos</a>
    </div>

    <!-- CPU / RAM -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">CPU</div>
                <div class="card-body">
                    <h3 id="cpu_val">--%</h3>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">RAM</div>
                <div class="card-body">
                    <h3 id="ram_val">--%</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Kafka (√∫ltimos eventos)</div>
                <div class="card-body">
                    <pre id="kafka_logs">Cargando...</pre>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">√öltimos errores</div>
                <div class="card-body">
                    <pre id="error_logs">Cargando...</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• NUEVO: GR√ÅFICO DE MONEDAS -->
    <div class="card mt-4">
        <div class="card-header">
            Gr√°fico de Monedas Internacionales (Microservicio)
        </div>
        <div class="card-body">
            <canvas id="monedasChart"></canvas>
        </div>
    </div>

</div>

<script>
function actualizarDashboard() {
    fetch("{% url 'monitor_data' %}")
        .then(r => r.json())
        .then(data => {
            document.getElementById("cpu_val").textContent = data.cpu + "%";
            document.getElementById("ram_val").textContent = data.ram + "%";

            document.getElementById("kafka_logs").textContent =
                data.kafka.length ? data.kafka.join("\n") : "Sin eventos";

            document.getElementById("error_logs").textContent =
                data.errors.length ? data.errors.join("\n") : "Sin errores";
        });
}

function cargarMonedas() {
    fetch("{% url 'monitor_monedas' %}")
        .then(r => r.json())
        .then(data => {
            const labels = Object.keys(data.rates);
            const values = Object.values(data.rates);

            new Chart(document.getElementById("monedasChart"), {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Valor respecto a " + data.base,
                        data: values
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 90,
                                minRotation: 90
                            }
                        }
                    }
                }
            });
        });
}

setInterval(actualizarDashboard, 2000);
actualizarDashboard();
cargarMonedas();
</script>

</body>
</html>
